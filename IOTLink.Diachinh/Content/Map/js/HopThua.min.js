var HopThua={GLOBAL:{checkHopThua:!1,listHopThua:[],listPolylineHopThua:[]},CONSTS:{},SELECTORS:{btnHopThua:".btn-hop-thua",btnSaveHopThua:".btn-save-hop-thua",btnHuyHopThua:".btn-huy-hop-thua",formInforHopThua:".form-infor-hop-thua",KHList:".form-infor-hop-thua #KH-listselectid",SoToUpdate:".form-infor-hop-thua #text-update-soTo",SoThuaUpdate:".form-infor-hop-thua #text-update-soThua",SoToUpdateOld:".form-infor-hop-thua #text-update-soTo-old",SoThuaUpdateOld:".form-infor-hop-thua #text-update-soThua-old",DienTichUpdate:".form-infor-hop-thua #text-update-dienTich",DienTichPhapLyUpdate:".form-infor-hop-thua #text-update-dienTichPhapLy",TenChuUpdate:".form-infor-hop-thua #text-update-chuNha",DiaChiUpdate:".form-infor-hop-thua #text-update-diaChi",btnUpdateThuaDat:".form-infor-hop-thua .btn-infor-hop-thua"},init:function(){HopThua.setEvent();HopThua.addSelectMucDich()},setEvent:function(){let n=map.data.addListener("click",n=>{HopThua.GLOBAL.checkHopThua?HopThua.getInforThuaDat(n.location.lat,n.location.lng):HopThua.GLOBAL.listHopThua=[]});$(HopThua.SELECTORS.btnHopThua).on("click",function(){HopThua.GLOBAL.checkHopThua=!HopThua.GLOBAL.checkHopThua;HopThua.GLOBAL.checkHopThua&&($(this).attr("disabled","disabled"),$(HopThua.SELECTORS.btnSaveHopThua).removeAttr("disabled"),$(HopThua.SELECTORS.btnHuyHopThua).removeAttr("disabled"))});$(HopThua.SELECTORS.btnHuyHopThua).on("click",function(){HopThua.GLOBAL.checkHopThua=!1;HopThua.GLOBAL.checkHopThua||($(HopThua.SELECTORS.btnHopThua).removeAttr("disabled"),$(HopThua.SELECTORS.btnSaveHopThua).attr("disabled","disabled"),$(HopThua.SELECTORS.btnHuyHopThua).attr("disabled","disabled"),HopThua.clearPolylineHopThua())});$(HopThua.SELECTORS.btnSaveHopThua).on("click",function(){if(HopThua.GLOBAL.listHopThua.length>1){if($(HopThua.SELECTORS.formInforHopThua).modal("show"),ViewMap.GLOBAL.commonData!==null&&typeof ViewMap.GLOBAL.commonData!="undefined"){let r=ViewMap.GLOBAL.commonData.features[0].properties;$(HopThua.SELECTORS.SoToUpdate).val(r.SoHieuToBanDo);$(".form-infor-hop-thua #KH-listselectid option[value='"+r.KyHieuMucDichSuDung+"']").attr("selected","selected");let t=0,i=0;for(var n=0;n<HopThua.GLOBAL.listHopThua.length;n++){let r=HopThua.GLOBAL.listHopThua[n].features[0].properties.info==="vn2000"?HopThua.GLOBAL.listHopThua[n].features[0]:HopThua.GLOBAL.listHopThua[n].features[1];t=t+r.properties.DienTich;i=i+r.properties.DienTichPhapLy}$(HopThua.SELECTORS.DienTichUpdate).val(t);$(HopThua.SELECTORS.DienTichPhapLyUpdate).val(i)}}else swal({title:"Thông báo",text:"Bạn chọn ít nhất 2 thửa đất!",icon:"warning",button:"Đóng"})});$(HopThua.SELECTORS.btnUpdateThuaDat).on("click",function(){if(HopThua.checkFormInfor()){let t="",i=[];for(var n=0;n<HopThua.GLOBAL.listHopThua.length;n++){let r=HopThua.GLOBAL.listHopThua[n].features[0].properties.info==="vn2000"?HopThua.GLOBAL.listHopThua[n].features[0]:HopThua.GLOBAL.listHopThua[n].features[1];t=r.properties.MaXa;let u={id:r.properties.Id,objectId:r.properties.ObjectId,uuid:r.properties.UUID,thoiDiemBatDau:r.properties.ThoiDiemBatDau,thoiDiemKetThuc:r.properties.ThoiDiemKetThuc,maXa:r.properties.MaXa,maDoiTuong:r.properties.MaDoiTuong,soHieuToBanDo:r.properties.SoHieuToBanDo,soThuTuThua:r.properties.SoThuTuThua,soHieuToBanDoCu:r.properties.SoHieuToBanDoCu,soThuTuThuaCu:r.properties.SoThuTuThuaCu,dienTich:r.properties.DienTich,dienTichPhapLy:r.properties.DienTichPhapLy,kyHieuMucDichSuDung:r.properties.KyHieuMucDichSuDung,kyHieuDoiTuong:"",tenChu:r.properties.TenChu,diaChi:r.properties.DiaChi,daCapGCN:0,tenChu2:r.properties.TenChu2,namSinhC1:r.properties.NamSinhC1,soHieuGCN:r.properties.SoHieuGCN,soVaoSo:r.properties.SoVaoSo,ngayVaoSo:r.properties.NgayVaoSo,soBienNhan:0,nguoiNhanHS:r.properties.NguoiNhanHS,coQuanThuLy:r.properties.CoQuanThuLy,loaiHS:r.properties.LoaiHS,maLienKet:r.properties.MaLienKet,shapeSTArea:0,shapeSTLength:0,shapeLength:r.properties.ShapeArea,shapeArea:r.properties.ShapeLength,geometry:r.geometry,tags:{}};i.push(u)}let r=HopThua.getPolygonHopThuaNew(),u=r.geometry,f={objectId:0,uuid:"",thoiDiemBatDau:null,thoiDiemKetThuc:null,maXa:t,maDoiTuong:"",soHieuToBanDo:Number($(HopThua.SELECTORS.SoToUpdate).val()),soThuTuThua:Number($(HopThua.SELECTORS.SoThuaUpdate).val()),soHieuToBanDoCu:$(HopThua.SELECTORS.SoToUpdateOld).val(),soThuTuThuaCu:$(HopThua.SELECTORS.SoThuaUpdateOld).val(),dienTich:Number($(HopThua.SELECTORS.DienTichUpdate).val()),dienTichPhapLy:Number($(HopThua.SELECTORS.DienTichPhapLyUpdate).val()),kyHieuMucDichSuDung:$(HopThua.SELECTORS.KHList).val(),kyHieuDoiTuong:"",tenChu:$(HopThua.SELECTORS.TenChuUpdate).val(),diaChi:$(HopThua.SELECTORS.DiaChiUpdate).val(),daCapGCN:0,tenChu2:"",namSinhC1:"",soHieuGCN:"",soVaoSo:"",ngayVaoSo:"",soBienNhan:0,nguoiNhanHS:"",coQuanThuLy:"",loaiHS:"",maLienKet:"",shapeSTArea:0,shapeSTLength:0,shapeLength:0,shapeArea:0,geometry:u,tags:{}},e={from:i,to:f};HopThua.updateHopThua(e)}});$(HopThua.SELECTORS.formInforHopThua).on("hide.bs.modal",function(){$(HopThua.SELECTORS.SoToUpdate).val(0);$(HopThua.SELECTORS.SoThuaUpdate).val(0);$(HopThua.SELECTORS.SoToUpdateOld).val(0);$(HopThua.SELECTORS.SoThuaUpdateOld).val(0);$(HopThua.SELECTORS.DienTichUpdate).val(0);$(HopThua.SELECTORS.DienTichPhapLyUpdate).val(0);$(HopThua.SELECTORS.TenChuUpdate).val("");$(HopThua.SELECTORS.DiaChiUpdate).val("")})},getInforThuaDat:function(n,t){$.ajax({type:"GET",url:ViewMap.GLOBAL.url+"/v2/api/land/latlng",data:{lat:n,lng:t,key:ViewMap.CONSTS.key},success:function(n){if(console.log(n),n.code==="ok"&&n.result!==null&&n.result.features.length>0){let t=HopThua.checkHopThua(n.result),i=HopThua.checkDuplicatePolygon(n.result);if(t&&i){HopThua.GLOBAL.listHopThua.push(n.result);let t=n.result.features[0].properties.info==="wgs84"?n.result.features[0].geometry:n.result.features[1].geometry;HopThua.setSelectThuaDat(t)}}},error:function(n,t,i){let r=AppCommon.getMessageErrorReuqest(n,i);console.log(r);ViewMap.showLoading(!1)}})},checkHopThua:function(n){var i,t;let r=!1;if(ViewMap.GLOBAL.commonData!==null&&ViewMap.GLOBAL.commonData.features!=="undefined"&&ViewMap.GLOBAL.commonData.features.length>0){HopThua.GLOBAL.listHopThua.length===0&&HopThua.GLOBAL.listHopThua.push(ViewMap.GLOBAL.commonData);let f=n.features[0].properties.info==="vn2000"?n.features[0]:n.features[1],u=HopThua.getCoordinatesSearch(f.geometry)[0];for(i=0;i<HopThua.GLOBAL.listHopThua.length;i++){let n=HopThua.GLOBAL.listHopThua[i],e=n.features[0].properties.info==="vn2000"?n.features[0]:n.features[1],f=HopThua.getCoordinatesSearch(e.geometry)[0],o=f.slice(0);for(o.pop(),t=0;t<u.length;t++){let n=f.filter(n=>n[0]===u[t][0]&&n[1]===u[t][1]);if(n.length>0){r=!0;break}}if(r)break}}return r},getPolygonHopThua:function(){var t,i;let n=[],r=HopThua.GLOBAL.listHopThua;for(t=0;t<r.length;t++){let f=r[t].features[0].properties.info==="vn2000"?r[t].features[0]:r[t].features[1],e=HopThua.getCoordinatesSearch(f.geometry)[0],u=e.slice(0);if(u[0][0]===u[u.length-1][0]&&u.pop(),n.length===0)n=u.slice(0);else for(i=0;i<u.length;i++){let t=n.filter(n=>n[0]===u[i][0]&&n[1]===u[i][1]);t.length<=0&&n.push(u[i])}}return console.log(JSON.stringify(n)),n.length>0&&(n=HopThua.orderClockWiseVN2000(n)),console.log(JSON.stringify(n)),n},getPolygonHopThuaNew:function(){let i=HopThua.GLOBAL.listHopThua,n=null;for(var t=0;t<i.length;t++){let r=i[t].features[0].properties.info==="vn2000"?i[t].features[0]:i[t].features[1];n=n!==null?turf.union(n,r):r}return n},setSelectThuaDat:function(n){let i=HopThua.getCoordinatesSearch(n);for(var t=0;t<i.length;t++)polyline=new map4d.Polyline({path:i[t],strokeColor:"#00ffff",strokeOpacity:1,strokeWidth:2}),polyline.setMap(map);HopThua.GLOBAL.listPolylineHopThua.push(polyline)},getCoordinatesSearch:function(n){let i=[];if(n.type==="Polygon"){let t=n.coordinates.length;return n.coordinates}if(n.type==="MultiPolygon"){let r=n.coordinates[0].length;for(var t=0;t<r;t++){let r=n.coordinates[0][t];i.push(r)}return i}},orderClockWiseVN2000:function(n){var t=n.slice(0),r=0,u=0,f,i;for($.each(t,function(n,t){r=r+t[0];u=u+t[1]}),r=r/t.length,u=u/t.length,t.sort(function(n,t){let i=Math.atan2(n[1]-u,n[0]-r),f=Math.atan2(t[1]-u,t[0]-r);return i-f}),f=[],i=0;i<t.length;i++)i===t.length-1?f.push(t[i]):t[i][0]!==t[i+1][0]&&t[i][1]!==t[i+1][1]&&f.push(t[i]);return f},orderClockWiseWGS84:function(n){var t=n.slice(0),r=0,u=0,f,i;for($.each(t,function(n,t){r=r+t[0];u=u+t[1]}),r=r/t.length,u=u/t.length,t.sort(function(n,t){let i=Math.atan2(n[1]-u,n[0]-r),f=Math.atan2(t[1]-u,t[0]-r);return i-f}),f=[],i=0;i<t.length;i++)i===t.length-1?f.push(t[i]):t[i][0]!==t[i+1][0]&&t[i][1]!==t[i+1][1]&&f.push(t[i]);return f},clearPolylineHopThua:function(){$.each(HopThua.GLOBAL.listPolylineHopThua,function(n,t){t.setMap(null)});HopThua.GLOBAL.listHopThua=[]},updateHopThua:function(n){$.ajax({type:"POST",url:ViewMap.GLOBAL.url+"/v2/api/land/hop-thua?key="+ViewMap.CONSTS.key,data:JSON.stringify(n),dataType:"json","async":!1,contentType:"application/json-patch+json",success:function(n){n.code==="ok"&&(HopThua.GLOBAL.checkHopThua=!HopThua.GLOBAL.checkHopThua,HopThua.GLOBAL.checkHopThua||($(HopThua.SELECTORS.btnHopThua).removeAttr("disabled"),$(HopThua.SELECTORS.btnSaveHopThua).attr("disabled","disabled"),$(HopThua.SELECTORS.btnHuyHopThua).attr("disabled","disabled")),swal({title:"Thông báo",text:"Cập nhật thông tin hợp thửa thành công!",icon:"success",button:"Đóng"}).then(()=>{$(HopThua.SELECTORS.formInforHopThua).modal("hide"),RemoveUrlToThua(),setTimeout(function(){location.reload()},500)}))},error:function(n,t,i){let r=AppCommon.getMessageErrorReuqest(n,i);console.log(r);ViewMap.showLoading(!1)}})},checkFormInfor:function(){let n=!0,t=$(HopThua.SELECTORS.SoThuaUpdate).val();validateText(t,"number",0,0)&&t!=="0"||(insertError($(HopThua.SELECTORS.SoThuaUpdate),"other"),n=!1);let i=$(HopThua.SELECTORS.SoToUpdate).val();validateText(i,"number",0,0)&&i!=="0"||(insertError($(HopThua.SELECTORS.SoToUpdate),"other"),n=!1);let r=$(HopThua.SELECTORS.DienTichUpdate).val();validateText(r,"float",0,0)&&r!=="0"||(insertError($(HopThua.SELECTORS.DienTichUpdate),"other"),n=!1);let u=$(HopThua.SELECTORS.DienTichPhapLyUpdate).val();validateText(u,"float",0,0)&&u!=="0"||(insertError($(HopThua.SELECTORS.DienTichPhapLyUpdate),"other"),n=!1);let f=$(HopThua.SELECTORS.TenChuUpdate).val();return validateText(f,"text",0,0)||(insertError($(HopThua.SELECTORS.TenChuUpdate),"other"),n=!1),n},checkDuplicatePolygon:function(n){let i=n.features[0].properties,r=0;for(var t=0;t<HopThua.GLOBAL.listHopThua.length;t++){let n=HopThua.GLOBAL.listHopThua[t].features[0].properties;i.SoHieuToBanDo===n.SoHieuToBanDo&&i.SoThuTuThua===n.SoThuTuThua&&r++}return r>0?!1:!0},addSelectMucDich:function(){$.ajax({type:"GET",url:ViewMap.GLOBAL.url+"/v2/api/land/all-muc-dich-su-dung",data:{key:ViewMap.CONSTS.key},success:function(n){if(n.code=="ok"&&n.result!=null&&n.result.length>0){let i="";for(var t=0;t<n.result.length;t++)i+=`<option value="${n.result[t].mucDichSuDung}">
                                        ${n.result[t].name}
                                    </option>`;$(HopThua.SELECTORS.KHList).append(i)}else swal({title:"Thông báo",text:"Không tìm thấy thành phố địa chính",icon:"warning",button:"Đóng"}).then(()=>{})},error:function(n,t,i){let r=AppCommon.getMessageErrorReuqest(n,i);console.log(r)}})}};