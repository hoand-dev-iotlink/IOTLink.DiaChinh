var EditMode3D={GLOBAL:{polygon:null,path:null,isStartDraw:!1,isEditDraw:!1,listMarker:[],listPolyline:[],polylineTemp:null,polygonDraw:null,objFile:null,textureFile:null,objectModel:null,locationObject:{},scale:1,bearing:0,elevation:0,heightScale:1,objectModeDefault:null,fileObjSave:null,fileTextureSave:null,lstResultfile:{obj:null,image:null},listObjectEdit:[],objectModelEidt:null},CONSTS:{key:"208e1c99aa440d8bc2847aafa3bc0669",sizeFile:500},SELECTORS:{modalMode3D:".modal-edit-mode-3d",btnMode3D:".btn-edit-mode-3d",iCheck:'input[type="checkbox"].flat-red, input[type="radio"].flat-red',modelObject:"input[name='modelObject']",drawObject:"#drawObject",modelObjectCheck:"input[name='modelObject']:checked",formUpdateMode:".upload-object",formDrawMode:".draw-object",formModeObject:".object-mode",btnStartDraw:"#btnStartDraw",btnEditDraw:"#btnEditDraw",btnEndDraw:"#btnEndDraw",btnDeleteDraw:"#btnDeleteDraw",txtScale:"#Scale",txtBearing:"#Bearing",txtElevation:"#Elevation",txtHeightScale:"#HeightScale",txtHeightfloor:"#Heightfloor",txtAreaFloor:"#AreaFloor",txtNameObject:"#txtName",inputFile:"#objFile",selectObjectMode:".object-mode-3d",btnSaveMode3D:".btn-save-mode-3d",focusInput:".project-content input",loadingModel3D:".modal-edit-mode-3d #loading-map-mode3d"},init:function(){mapMode3D=null;$(EditMode3D.SELECTORS.btnMode3D).on("click",function(){(mapMode3D===null||typeof mapMode3D=="undefined"||mapMode3D==="")&&(mapMode3D=new map4d.Map(document.getElementById("mapMode3D"),{zoom:17,center:{lat:10.678087311284315,lng:105.08063708265138},geolocate:!0,minZoom:3,maxZoom:22,tilt:63,controls:!0,controlOptions:map4d.ControlOptions.BOTTOM_RIGHT,accessKey:"208e1c99aa440d8bc2847aafa3bc0669"}),mapMode3D.setTileFeatureVisible(!1,!0),mapMode3D.setTileUrl("http://61.28.233.229:8080/all/2d/{z}/{x}/{y}.png"),mapMode3D.setTileUrl("http://61.28.233.229:8080/all/3d/{z}/{x}/{y}.png",!0),mapMode3D.setPlacesEnabled(!1),mapMode3D.setSwitchMode(map4d.SwitchMode.Auto),EditMode3D.setEvent());setTimeout(function(){EditMode3D.drawPolygon(ViewMap.GLOBAL.commonData);setTimeout(function(){EditMode3D.fitBoundsThuaDat(EditMode3D.GLOBAL.path);var n=mapMode3D.getCamera();let t=n.getZoom();n.setZoom(t-1);n.setTilt(63);mapMode3D.setCamera(n)},1e3)},1);$(EditMode3D.SELECTORS.modalMode3D).modal("show")})},setEvent:function(){$(EditMode3D.SELECTORS.modalMode3D).on("shown.bs.modal",function(){mapMode3D.showMapObject(!1);map.showMapObject(!1);map.enable3dMode(!1);setTimeout(function(){EditMode3D.getObjectOnThuaDat()},1e3)});$(EditMode3D.SELECTORS.modalMode3D).on("hidden.bs.modal",function(){EditMode3D.resetPolygon();EditMode3D.GLOBAL.isStartDraw=!1;EditMode3D.GLOBAL.isEditDraw=!1;EditMode3D.GLOBAL.locationObject={};$(EditMode3D.SELECTORS.drawObject).attr("checked","checked");$(EditMode3D.SELECTORS.drawObject).prop("checked",!0);$(EditMode3D.SELECTORS.formUpdateMode).hide();$(EditMode3D.SELECTORS.formDrawMode).show();$(EditMode3D.SELECTORS.formModeObject).hide();$(EditMode3D.SELECTORS.txtScale).val(1);$(EditMode3D.SELECTORS.txtBearing).val(0);$(EditMode3D.SELECTORS.txtHeightScale).val(1);$(EditMode3D.SELECTORS.txtElevation).val(0);$(EditMode3D.SELECTORS.selectObjectMode).val("0");$(EditMode3D.SELECTORS.txtAreaFloor).val(0);$(EditMode3D.SELECTORS.txtHeightfloor).val(1);$(EditMode3D.SELECTORS.txtNameObject).val("");map.showMapObject(!0);map.enable3dMode(!1)});$(EditMode3D.SELECTORS.modelObject).on("change",function(){let n=$(EditMode3D.SELECTORS.modelObjectCheck).val();n==="2"&&($(EditMode3D.SELECTORS.formDrawMode).show(),$(EditMode3D.SELECTORS.formUpdateMode).hide(),$(EditMode3D.SELECTORS.formModeObject).hide());typeof EditMode3D.GLOBAL.locationObject.lat!="undefined"?(n==="1"&&($(EditMode3D.SELECTORS.formUpdateMode).show(),$(EditMode3D.SELECTORS.formDrawMode).hide(),$(EditMode3D.SELECTORS.formModeObject).hide()),n==="3"&&($(EditMode3D.SELECTORS.formUpdateMode).hide(),$(EditMode3D.SELECTORS.formDrawMode).hide(),$(EditMode3D.SELECTORS.formModeObject).show())):($(EditMode3D.SELECTORS.drawObject).attr("checked","checked"),$(EditMode3D.SELECTORS.drawObject).prop("checked",!0),swal({title:"Thông báo",text:"Bạn chưa vẽ đáy tòa nhà",icon:"warning",button:"Đóng"}).then(()=>{}))});$(EditMode3D.SELECTORS.selectObjectMode).on("change.select2",function(){let n=$(this).val(),t=$(this).find("option[value = '"+n+"']").attr("data-objname"),i=$(this).find("option[value = '"+n+"']").attr("data-texturename");EditMode3D.createObjectModeDefault(n,EditMode3D.GLOBAL.locationObject.lat,EditMode3D.GLOBAL.locationObject.lng,EditMode3D.GLOBAL.scale,EditMode3D.GLOBAL.bearing,EditMode3D.GLOBAL.elevation,t,i)});$(EditMode3D.SELECTORS.btnSaveMode3D).on("click",function(){EditMode3D.saveMode3D()});$(EditMode3D.SELECTORS.focusInput).on("click",function(){$(this).parent().removeClass("has-error")});let n=mapMode3D.addListener("click",n=>{if(EditMode3D.GLOBAL.isStartDraw){if(EditMode3D.createMarkerDrawLoDat(n.location.lat,n.location.lng,!1),EditMode3D.GLOBAL.listMarker.length<=2){let n=[];$.each(EditMode3D.GLOBAL.listMarker,function(){let t={lat:this.getPosition().lat,lng:this.getPosition().lng};n.push(t)});EditMode3D.createPolylineLoDat(n,3,1,!0)}if(EditMode3D.GLOBAL.listMarker.length>2){let n=[];$.each(EditMode3D.GLOBAL.listMarker,function(){let t={lat:this.getPosition().lat,lng:this.getPosition().lng};n.push(t)});n.push(n[0]);EditMode3D.createPolygonArea(n)}}},{polygon:!0,polyline:!0}),t=mapMode3D.addListener("mouseMove",n=>{if(EditMode3D.GLOBAL.isStartDraw&&EditMode3D.GLOBAL.listMarker.length>0){let i=[],t=EditMode3D.GLOBAL.listMarker,r=[t[t.length-1].getPosition().lng,t[t.length-1].getPosition().lat],u=[n.location.lng,n.location.lat];i.push(r);i.push(u);EditMode3D.createPolylineByMouseMoveLoDat(i,3,.7);EditMode3D.ShowMeterDraw(r,u)}EditMode3D.GLOBAL.isStartDraw||EditMode3D.GLOBAL.polylineTemp==null||EditMode3D.GLOBAL.polylineTemp.setMap(null)}),i=mapMode3D.addListener("dblClick",()=>{EditMode3D.GLOBAL.isStartDraw&&(EditMode3D.GLOBAL.isStartDraw=!1,markerMeter.setMap(null),$(EditMode3D.SELECTORS.btnEndDraw).trigger("click"),EditMode3D.previewObjectOnMap())},{marker:!0}),r=mapMode3D.addListener("drag",function(n){if(EditMode3D.GLOBAL.isEditDraw){let t=EditMode3D.GLOBAL.listMarker;for(let i=0;i<t.length;i++)if(t[i].id==n.marker.id){if(t[i]=n.marker,t.length>2){let n=[];$.each(t,function(){let t={lat:this.getPosition().lat,lng:this.getPosition().lng};n.push(t)});n.push(n[0]);EditMode3D.createPolygonArea(n);EditMode3D.previewObjectOnMap()}break}}},{marker:!0}),u=mapMode3D.addListener("drag",function(){lat=EditMode3D.GLOBAL.objectModel.getLocation().lat;lng=EditMode3D.GLOBAL.objectModel.getLocation().lng;let n=$(EditMode3D.SELECTORS.modelObjectCheck).val();n==="2"&&EditMode3D.GLOBAL.objectModel!=null&&(EditMode3D.GLOBAL.objectModel.getTransformedCoordinates().length>0?EditMode3D.updateMarkerDrawAndPolygonDraw():EditMode3D.movePolygonModelToLocation(lat,lng))},{object:!0}),f=mapMode3D.addListener("click",function(n){console.log(n);let t=EditMode3D.GLOBAL.listObjectEdit.find(t=>t.id==n.object.id);if(typeof t!="undefined"&&t!==null&&typeof t.id!="undefined"){let n=t.polygon;if(typeof n!="undefined"&&n!==null){for(var i=0;i<n.paths[0].length-1;i++){let t=n.paths[0][i];EditMode3D.createMarkerDrawLoDat(t.lat,t.lng)}EditMode3D.GLOBAL.polygonDraw=n;$(EditMode3D.SELECTORS.btnStartDraw).addClass("hide");$(EditMode3D.SELECTORS.btnEndDraw).addClass("hide");$(EditMode3D.SELECTORS.btnEditDraw).removeClass("hide");$(EditMode3D.SELECTORS.btnDeleteDraw).removeClass("hide")}typeof t.object!="undefined"&&(EditMode3D.GLOBAL.objectModel=t.object,EditMode3D.GLOBAL.objectModelEidt=t.object.id,$(EditMode3D.SELECTORS.txtScale).val(t.object.scale),$(EditMode3D.SELECTORS.txtBearing).val(t.object.bearing),$(EditMode3D.SELECTORS.txtHeightScale).val(t.object.height),$(EditMode3D.SELECTORS.txtElevation).val(t.object.elevation),typeof t.tags!="undefined"&&t.tags.area!=="undefined"&&t.tags.floor!=="undefined"&&($(EditMode3D.SELECTORS.txtAreaFloor).val(t.tags.area),$(EditMode3D.SELECTORS.txtHeightfloor).val(t.tags.floor)),typeof t.name!="undefined"&&t.name!==""&&t.name!==null&&$(EditMode3D.SELECTORS.txtNameObject).val(t.name),EditMode3D.updateLocation())}},{object:!0});$(EditMode3D.SELECTORS.inputFile).on("change",function(){for(var t=this.files,n=0;n<t.length;n++)if(t[n].size<=512e3){if(t[n].type.split("/")[0]=="image"){let r=t[n],i=new FileReader;i.readAsDataURL(r);i.onload=function(){EditMode3D.GLOBAL.textureFile=i.result;EditMode3D.previewObjectOnMap()};EditMode3D.GLOBAL.fileTextureSave=t[n]}if(t[n].name.split(".")[1]=="obj"){let r=t[n],i=new FileReader;i.readAsText(r);i.onload=function(){EditMode3D.GLOBAL.objFile=i.result;EditMode3D.previewObjectOnMap()};EditMode3D.GLOBAL.fileObjSave=t[n]}}else swal({title:"Thông báo",text:`File ${t[n].name} vượt quá dung lượng 500kB`,icon:"warning",button:"Đóng"})});$(EditMode3D.SELECTORS.btnStartDraw).on("click",function(){EditMode3D.resetPolygon();EditMode3D.GLOBAL.isStartDraw=!0;EditMode3D.GLOBAL.isEditDraw=!1;$(EditMode3D.SELECTORS.btnStartDrawLoDat).prop("disabled",!0);$(EditMode3D.SELECTORS.btnEditDrawLoDat).prop("disabled",!0);$(EditMode3D.SELECTORS.btnStartDraw).addClass("hide");$(EditMode3D.SELECTORS.btnEndDraw).removeClass("hide");$(EditMode3D.SELECTORS.btnDeleteDraw).removeClass("hide")});$(EditMode3D.SELECTORS.btnEndDraw).on("click",function(){EditMode3D.GLOBAL.polygonDraw!=null?(EditMode3D.GLOBAL.isStartDraw=!1,EditMode3D.GLOBAL.isEditDraw=!1,EditMode3D.changeEditMode(),$(EditMode3D.SELECTORS.btnStartDraw).addClass("hide"),$(EditMode3D.SELECTORS.btnEndDraw).addClass("hide"),$(EditMode3D.SELECTORS.btnEditDraw).removeClass("hide"),$(EditMode3D.SELECTORS.btnDeleteDraw).removeClass("hide")):$(EditMode3D.SELECTORS.btnDeleteDraw).trigger("click")});$(EditMode3D.SELECTORS.btnEditDraw).on("click",function(){EditMode3D.GLOBAL.listMarker.length>2?(EditMode3D.GLOBAL.isStartDraw=!1,EditMode3D.GLOBAL.isEditDraw=!0,EditMode3D.changeEditMode(),$(EditMode3D.SELECTORS.btnStartDraw).addClass("hide"),$(EditMode3D.SELECTORS.btnEditDraw).addClass("hide"),$(EditMode3D.SELECTORS.btnEndDraw).removeClass("hide"),$(EditMode3D.SELECTORS.btnDeleteDraw).removeClass("hide")):$(EditMode3D.SELECTORS.btnDeleteDraw).trigger("click")});$(EditMode3D.SELECTORS.btnDeleteDraw).on("click",function(){$(EditMode3D.SELECTORS.btnStartDrawLoDat).prop("disabled",!1);$(EditMode3D.SELECTORS.btnEditDrawLoDat).prop("disabled",!1);EditMode3D.GLOBAL.objectModelEidt!==null?swal({title:"Thông báo",text:"Bạn có chắc chắn xóa đối tượng này không!",icon:"warning",buttons:["Hủy","Đồng ý"],dangerMode:!0}).then(n=>{n&&EditMode3D.GLOBAL.objectModel!=null&&EditMode3D.deleteModel3D(EditMode3D.GLOBAL.objectModelEidt)}):EditMode3D.resetPolygon()});$Bearing=$(EditMode3D.SELECTORS.txtBearing).spinner({max:180,min:-180});$Scale=$(EditMode3D.SELECTORS.txtScale).spinner({step:.1,min:0});$Elevation=$(EditMode3D.SELECTORS.txtElevation).spinner();$HeightScale=$(EditMode3D.SELECTORS.txtHeightScale).spinner();$floorArea=$(EditMode3D.SELECTORS.floorArea).spinner({min:0,step:.1});$heightBuilding=$(EditMode3D.SELECTORS.heightBuilding).spinner({min:0,step:.1});$(EditMode3D.SELECTORS.txtScale).on("spinstop",function(){EditMode3D.GLOBAL.scale=parseFloat($(this).spinner("value"));EditMode3D.GLOBAL.objectModel!=null&&(EditMode3D.GLOBAL.objectModel.setScale(EditMode3D.GLOBAL.scale),EditMode3D.GLOBAL.objectModel.getTransformedCoordinates().length>0&&(EditMode3D.updateMarkerDrawAndPolygonDraw(),EditMode3D.updateLocation()))});$(EditMode3D.SELECTORS.txtBearing).on("spinstop",function(){EditMode3D.GLOBAL.bearing=parseFloat($(this).spinner("value"));EditMode3D.GLOBAL.objectModel!=null&&EditMode3D.GLOBAL.objectModel.setBearing(EditMode3D.GLOBAL.bearing);EditMode3D.GLOBAL.polygonDraw!=null&&EditMode3D.GLOBAL.objectModel!=null&&EditMode3D.GLOBAL.objectModel.getTransformedCoordinates().length>0&&(EditMode3D.updateMarkerDrawAndPolygonDraw(),EditMode3D.updateLocation())});$(EditMode3D.SELECTORS.txtElevation).on("spinstop",function(){EditMode3D.GLOBAL.elevation=parseFloat($(this).spinner("value"));EditMode3D.GLOBAL.objectModel!=null&&EditMode3D.GLOBAL.objectModel.setElevation(EditMode3D.GLOBAL.elevation)});$(EditMode3D.SELECTORS.txtHeightScale).on("spinstop",function(){EditMode3D.GLOBAL.heightScale=parseFloat($(this).spinner("value"));EditMode3D.GLOBAL.objectModel!=null&&EditMode3D.GLOBAL.objectModel.setHeight(EditMode3D.GLOBAL.heightScale)});EditMode3D.setSelectObjectModel()},setSelectObjectModel:function(){$.ajax({type:"GET",url:"https://api.map4d.vn//v2/api/model/all",data:{key:EditMode3D.CONSTS.key},success:function(n){if((n.code="ok"&&n.result!=null&&typeof n.result!="undefined")&&n.result.length>0){let i=n.result,r="<option value='0'>---chọn mẫu---<\/option>";for(var t=0;t<i.length;t++)r+="<option value='"+i[t].id+"' data-objName='"+i[t].objName+"' data-textureName='"+i[t].textureName+"'>"+i[t].name+"<\/option>";$(EditMode3D.SELECTORS.selectObjectMode).append(r)}},error:function(n,t,i){let r=AppCommon.getMessageErrorReuqest(n,i);console.log(r);ViewMap.showLoading(!1)}})},resetPolygon:function(){EditMode3D.GLOBAL.objectModel!=null&&(EditMode3D.GLOBAL.objectModel.setMap(null),EditMode3D.GLOBAL.objectModel=null);EditMode3D.GLOBAL.polygonDraw!=null&&(EditMode3D.GLOBAL.polygonDraw.setMap(null),EditMode3D.GLOBAL.polygonDraw=null,EditMode3D.GLOBAL.objFile=null,EditMode3D.GLOBAL.textureFile=null,EditMode3D.GLOBAL.fileObjSave=null,EditMode3D.GLOBAL.fileTextureSave=null,EditMode3D.GLOBAL.lstResultfile.image=[],EditMode3D.GLOBAL.lstResultfile.obj=[]);EditMode3D.GLOBAL.objectModelEidt=null;$.each(EditMode3D.GLOBAL.listMarker,function(){this.setMap(null)});EditMode3D.GLOBAL.listMarker=[];EditMode3D.GLOBAL.isStartDraw=!1;EditMode3D.GLOBAL.isEditDraw=!1;$(EditMode3D.SELECTORS.btnStartDraw).removeClass("hide");$(EditMode3D.SELECTORS.btnEndDraw).addClass("hide");$(EditMode3D.SELECTORS.btnEditDraw).addClass("hide");$(EditMode3D.SELECTORS.btnDeleteDraw).addClass("hide")},drawPolygon:function(n){let i=n.features[0],t=EditMode3D.convertCoordinate(n.features[0]);EditMode3D.GLOBAL.polygon!==null&&EditMode3D.GLOBAL.polygon.setMap(null);EditMode3D.GLOBAL.polygon=new map4d.Polygon({paths:t,fillColor:"#0000ff",fillOpacity:.2,strokeColor:"#ea5252",strokeOpacity:1,strokeWidth:1});EditMode3D.GLOBAL.polygon.setMap(mapMode3D);EditMode3D.GLOBAL.path=t},convertCoordinate:function(n){let r=[],t=n.geometry;if(t.type==="Polygon"){let n=t.coordinates.length;return t.coordinates}if(t.type==="MultiPolygon"){let n=t.coordinates[0].length;for(var i=0;i<n;i++){let n=t.coordinates[0][i];r.push(n)}return r}},fitBoundsThuaDat:function(n){let i=new map4d.LatLngBounds;for(var t=0;t<n[0].length;t++)i.extend(n[0][t]);mapMode3D.fitBounds(i)},createMarkerDrawLoDat:function(n,t){let i=new map4d.Marker({position:{lat:n,lng:t},icon:new map4d.Icon(12,12,"/Content/Map/images/yellow-point.png"),anchor:[.5,.5]});i.setMap(mapMode3D);EditMode3D.GLOBAL.listMarker.push(i)},createPolylineLoDat:function(n,t,i){EditMode3D.GLOBAL.polylineTemp!=null&&EditMode3D.GLOBAL.polylineTemp.setMap(null);var r=new map4d.Polyline({path:n,visible:!0,strokeColor:"#FF8264",strokeWidth:t,strokeOpacity:i,closed:!1});r.setMap(mapMode3D);EditMode3D.GLOBAL.listPolyline.push(r)},createPolygonArea:function(n){EditMode3D.RemoveShape();EditMode3D.GLOBAL.polygonDraw!=null&&EditMode3D.GLOBAL.polygonDraw.setMap(null);EditMode3D.GLOBAL.polylineTemp!=null&&EditMode3D.GLOBAL.polylineTemp.setMap(null);let t=map4d.PolygonOptions={paths:[n],fillOpacity:.5};EditMode3D.GLOBAL.polygonDraw=new map4d.Polygon(t);EditMode3D.GLOBAL.polygonDraw.setMap(mapMode3D)},RemoveShape:function(){let n=EditMode3D.GLOBAL.listPolyline;$.each(n,function(n,t){t.setMap(null)})},ShowMeterDraw:function(n,t){let i=new map4d.Projection(map),r=i.fromLatLngToScreen([n[0],n[1]]),u=i.fromLatLngToScreen([t[0],t[1]]),e=(r.x+u.x)/2,o=(r.y+u.y)/2,f=i.fromScreenToLatLng({x:e,y:o}),s=new map4d.Measure([n,t,]),h=(Math.round(s.length*100)/100).toString();markerMeter!=null&&markerMeter.setMap(null);markerMeter=new map4d.Marker({position:{lat:f.lat,lng:f.lng},anchor:[.5,1],visible:!0,label:new map4d.MarkerLabel({text:h+" m",color:"000000",fontSize:12}),icon:new map4d.Icon(32,32,"")});markerMeter.setMap(mapMode3D)},createPolylineByMouseMoveLoDat:function(n,t,i){EditMode3D.GLOBAL.polylineTemp!=null&&EditMode3D.GLOBAL.polylineTemp.setMap(null);EditMode3D.GLOBAL.polylineTemp=new map4d.Polyline({path:n,visible:!0,strokeColor:"#FF8264",strokeWidth:t,strokeOpacity:i,closed:!1});EditMode3D.GLOBAL.polylineTemp.setMap(mapMode3D)},changeEditMode:function(){if(EditMode3D.GLOBAL.isEditDraw){for(let n=0;n<EditMode3D.GLOBAL.listMarker.length;n++)EditMode3D.GLOBAL.listMarker[n].setDraggable(!0);EditMode3D.GLOBAL.objectModel.setDraggable(!1)}else{for(let n=0;n<EditMode3D.GLOBAL.listMarker.length;n++)EditMode3D.GLOBAL.listMarker[n].setDraggable(!1);EditMode3D.GLOBAL.objectModel!=null&&EditMode3D.GLOBAL.objectModel.setDraggable(!0)}},previewObjectOnMap:function(){if(EditMode3D.GLOBAL.polygonDraw!=null)if(EditMode3D.GLOBAL.objFile!=null&&EditMode3D.GLOBAL.textureFile!=null&&EditMode3D.GLOBAL.objFile!=""&&EditMode3D.GLOBAL.textureFile!="")EditMode3D.createobjectModelByFile(EditMode3D.GLOBAL.locationObject.lat,EditMode3D.GLOBAL.locationObject.lng,EditMode3D.GLOBAL.scale,EditMode3D.GLOBAL.bearing,EditMode3D.GLOBAL.elevation,EditMode3D.GLOBAL.objFile,EditMode3D.GLOBAL.textureFile);else if((EditMode3D.GLOBAL.objectModel==null||EditMode3D.GLOBAL.objectModel.coordinates.length!=0||!(EditMode3D.GLOBAL.objectModel.obj.length>0))&&EditMode3D.GLOBAL.listMarker.length>2){let n=[];$.each(EditMode3D.GLOBAL.listMarker,function(){let t={lat:this.getPosition().lat,lng:this.getPosition().lng};n.push(t)});n.push(n[0]);EditMode3D.GLOBAL.objectModel!=null?EditMode3D.GLOBAL.objectModel.setCoordinates(n):EditMode3D.createobjectModelByCoordinates(EditMode3D.GLOBAL.elevation,EditMode3D.GLOBAL.heightScale,n)}},createobjectModelByCoordinates:function(n,t,i){EditMode3D.GLOBAL.objectModel!=null&&EditMode3D.GLOBAL.objectModel.setMap(null);EditMode3D.GLOBAL.objectModel=new map4d.MapObject({id:EditMode3D.createGuid(),scale:1,coordinates:i,bearing:0,elevation:n,height:t});EditMode3D.GLOBAL.objectModel.setMap(mapMode3D);EditMode3D.GLOBAL.objectModel.setDraggable(!0);mapMode3D.setSelectedObjects([EditMode3D.GLOBAL.objectModel.getId()]);EditMode3D.updateLocation()},movePolygonModelToLocation:function(n,t){if(EditMode3D.GLOBAL.polygonDraw!=null&&EditMode3D.GLOBAL.polygonDraw.setMap(null),$.each(EditMode3D.GLOBAL.listMarker,function(){this.setMap(null)}),EditMode3D.GLOBAL.listMarker=[],EditMode3D.GLOBAL.polygonDraw!=null){let r=EditMode3D.GLOBAL.polygonDraw.getPaths(),u=new map4d.CoordinateTransformer(r[0]),i=u.translate({lat:n,lng:t});if(i.length>2){let n=[];for(let t=0;t<i.length-1;t++){EditMode3D.createMarkerDrawLoDat(i[t].lat,i[t].lng);let r={lat:i[t].lat,lng:i[t].lng};n.push(r)}n.push(n[0]);EditMode3D.createPolygonArea(n)}}},updateMarkerDrawAndPolygonDraw:function(){if(EditMode3D.GLOBAL.polygonDraw!=null&&EditMode3D.GLOBAL.polygonDraw.setMap(null),$.each(EditMode3D.GLOBAL.listMarker,function(){this.setMap(null)}),EditMode3D.GLOBAL.listMarker=[],EditMode3D.GLOBAL.objectModel.getTransformedCoordinates().length>0){let n=EditMode3D.GLOBAL.objectModel.getTransformedCoordinates();if(n.length>2){let t=[];for(let i=0;i<n.length-1;i++){EditMode3D.createMarkerDrawLoDat(n[i].lat,n[i].lng);let r={lat:n[i].lat,lng:n[i].lng};t.push(r)}t.push(t[0]);EditMode3D.createPolygonArea(t)}}},updateLocation:function(){if(EditMode3D.GLOBAL.objectModel!=null){let n=EditMode3D.GLOBAL.objectModel.getLocation();n!=null&&(EditMode3D.GLOBAL.locationObject.lat=n.lat,EditMode3D.GLOBAL.locationObject.lng=n.lng)}},createobjectModelByFile:function(n,t,i,r,u,f,e){let o=EditMode3D.createGuid();EditMode3D.GLOBAL.objectModel!=null&&(o=EditMode3D.GLOBAL.objectModel.id,EditMode3D.GLOBAL.objectModel.setMap(null),EditMode3D.GLOBAL.objectModel=null);EditMode3D.GLOBAL.objectModel=new map4d.MapObject({name:"Tòa nhà",id:o,scale:i,bearing:r,elevation:u,location:{lat:n,lng:t},obj:{reuseId:"",data:f},texture:{reuseId:"",data:e}});EditMode3D.GLOBAL.objectModel.setMap(mapMode3D);EditMode3D.GLOBAL.objectModel.setDraggable(!0);EditMode3D.updateLocation()},createObjectModeDefault:function(n,t,i,r,u,f,e,o){let s=EditMode3D.createGuid();EditMode3D.GLOBAL.objectModel!=null&&(s=EditMode3D.GLOBAL.objectModel.id,EditMode3D.GLOBAL.objectModel.setMap(null),EditMode3D.GLOBAL.objectModel=null);EditMode3D.GLOBAL.objectModel=new map4d.MapObject({name:"Tòa nhà",id:n,scale:r,bearing:u,elevation:f,location:{lat:t,lng:i},obj:e,texture:o});EditMode3D.GLOBAL.objectModel.setMap(mapMode3D);EditMode3D.GLOBAL.objectModel.setDraggable(!0);EditMode3D.updateLocation()},createGuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var t=Math.random()*16|0,i=n==="x"?t:t&3|8;return i.toString(16)})},saveMode3D:function(){if(EditMode3D.checkFormInfor()){let t=[];if(EditMode3D.GLOBAL.objectModel!==null&&ViewMap.GLOBAL.commonData!==null){EditMode3D.GLOBAL.listMarker.length>2&&($.each(EditMode3D.GLOBAL.listMarker,function(){let n={lat:this.getPosition().lat,lng:this.getPosition().lng};t.push(n)}),t.push(t[0]));let i=ViewMap.GLOBAL.commonData.features[0];if(typeof i!="undefined"){let r=i.properties.SoHieuToBanDo,u=i.properties.SoThuTuThua,f=i.properties.MaXa;var n=null;if(EditMode3D.GLOBAL.objectModel.getTileCovers([17,18,19],function(t){n=t}),n!==null&&typeof n!="undefined")if(typeof EditMode3D.GLOBAL.objectModelEidt!="undefined"&&EditMode3D.GLOBAL.objectModelEidt!==null)EditMode3D.updateModel3DThuaDat(EditMode3D.GLOBAL.objectModelEidt,n,f,r,u,t);else{let i={name:$(EditMode3D.SELECTORS.txtNameObject).val(),places:[],location:{lng:EditMode3D.GLOBAL.objectModel.getLocation().lng,lat:EditMode3D.GLOBAL.objectModel.getLocation().lat},scale:EditMode3D.GLOBAL.objectModel.getScale(),bearing:EditMode3D.GLOBAL.objectModel.getBearing(),elevation:EditMode3D.GLOBAL.objectModel.getElevation(),heightScale:0,camera:{zoom:0,bearing:0,tilt:0,target:{lng:0,lat:0}},model:EditMode3D.setObjectModel(),types:[],minZoom:17,maxZoom:19,addressComponents:EditMode3D.getAddressComponents(EditMode3D.GLOBAL.objectModel.getLocation().lat,EditMode3D.GLOBAL.objectModel.getLocation().lng),startDate:EditMode3D.getDataNowFromat(),endDate:null,tiles:n,address:null,tags:{area:Number($(EditMode3D.SELECTORS.txtAreaFloor).val()),floor:Number($(EditMode3D.SELECTORS.txtHeightfloor).val())},maXa:f,soTo:r,soThua:u,polygon:t};EditMode3D.showLoading(!0);$.ajax({type:"POST",url:ViewMap.GLOBAL.url+"/v2/api/object?key="+ViewMap.CONSTS.key,data:JSON.stringify(i),dataType:"json","async":!0,contentType:"application/json-patch+json",success:function(n){EditMode3D.showLoading(!1);n.code=="ok"?swal({title:"Thông báo",text:"Cập nhật thông tin không gian 3D thành công!",icon:"success",button:"Đóng"}).then(()=>{$(EditMode3D.SELECTORS.modalMode3D).modal("hide"),map.showMapObject(!0),map.enable3dMode(!0)}):swal({title:"Thông báo",text:"Cập nhật đã bị lỗi hệ thống!",icon:"warning",button:"Đóng"}).then(()=>{$(EditMode3D.SELECTORS.modalMode3D).modal("hide"),map.showMapObject(!0),map.enable3dMode(!0)})},error:function(){console.log(messageErorr);swal({title:"Thông báo",text:"Cập nhật đã bị lỗi hệ thống!",icon:"warning",button:"Đóng"});EditMode3D.showLoading(!1)}});EditMode3D.showLoading(!1)}}}else swal({title:"Thông báo",text:"Chưa có dữ liệu không gian 3D",icon:"error",button:"Đóng"})}},getMode3DThuaDat:function(){if(ViewMap.GLOBAL.commonData!==null){let n=ViewMap.GLOBAL.commonData.features[0];if(typeof n!="undefined"){let t=n.properties.SoHieuToBanDo,i=n.properties.SoThuTuThua,r=n.properties.MaXa;$.ajax({type:"GET",url:"",data:{key:ViewMap.CONSTS.key},success:function(){},error:function(n,t,i){let r=AppCommon.getMessageErrorReuqest(n,i);console.log(r);ViewMap.showLoading(!1)}})}}},getDataNowFromat:function(){var i=new Date,n=""+(i.getMonth()+1),t=""+i.getDate(),r=i.getFullYear();return n.length<2&&(n="0"+n),t.length<2&&(t="0"+t),[r,n,t].join("-")},getAddressComponents:function(n,t){let i=[];return $.ajax({type:"GET",url:ViewMap.GLOBAL.url+"/v2/api/admin-level/latlng",data:{lat:n,lng:t,key:ViewMap.CONSTS.key},"async":!1,success:function(n){if(n.result.length>0)for(var t=n.result.length-1;t>=0;t--){let r=n.result[t];i.push({name:r.name,type:r.type,code:r.code})}},error:function(n,t,i){let r=AppCommon.getMessageErrorReuqest(n,i);console.log(r)}}),i},setObjectModel:function(){return EditMode3D.GLOBAL.objectModel.getCoordinates().length>0?{id:null,objName:EditMode3D.GLOBAL.objectModel.getObj(),color:null,type:"Polygon",coordinates:EditMode3D.GLOBAL.objectModel.getCoordinates(),height:EditMode3D.GLOBAL.objectModel.getHeight(),textureName:EditMode3D.GLOBAL.objectModel.getTexture()}:typeof EditMode3D.GLOBAL.objectModel.getTexture().reuseId!="undefined"&&typeof EditMode3D.GLOBAL.objectModel.getObj().reuseId!="undefined"&&(EditMode3D.saveObjectFile(),EditMode3D.GLOBAL.lstResultfile.obj!==null&&EditMode3D.GLOBAL.lstResultfile.image!==null)?{id:null,objName:EditMode3D.GLOBAL.lstResultfile.obj.name,color:null,type:"Object",coordinates:EditMode3D.GLOBAL.objectModel.getCoordinates(),height:0,textureName:EditMode3D.GLOBAL.lstResultfile.image.name}:typeof EditMode3D.GLOBAL.objectModel.getTexture().reuseId=="undefined"&&typeof EditMode3D.GLOBAL.objectModel.getObj().reuseId=="undefined"?{id:EditMode3D.GLOBAL.objectModel.getId(),objName:EditMode3D.GLOBAL.objectModel.getObj(),color:null,type:"Object",coordinates:EditMode3D.GLOBAL.objectModel.getCoordinates(),height:0,textureName:EditMode3D.GLOBAL.objectModel.getTexture()}:void 0},saveObjectFile:function(){var n,t;EditMode3D.GLOBAL.textureFile!=null||EditMode3D.GLOBAL.objFile!=null?(EditMode3D.GLOBAL.fileObjSave!=null&&(n=new FormData,n.append("file",EditMode3D.GLOBAL.fileObjSave),$.ajax({type:"POST",url:ViewMap.GLOBAL.url+"/v2/api/file/obj/?key="+ViewMap.CONSTS.key,data:n,"async":!1,contentType:!1,processData:!1,success:function(n){n.code=="ok"&&n.result!=null&&n.result!=null?EditMode3D.GLOBAL.lstResultfile.obj=n.result:swal({title:"Thông báo",text:"Không thể lưu file obj",icon:"error",button:"Đóng"}).then(()=>{})},error:function(n,t,i){let r=AppCommon.getMessageErrorReuqest(n,i);console.log(r);ViewMap.showLoading(!1)}})),EditMode3D.GLOBAL.fileTextureSave!=null&&(t=new FormData,t.append("file",EditMode3D.GLOBAL.fileTextureSave),$.ajax({type:"POST",url:ViewMap.GLOBAL.url+"/v2/api/file/texture/?key="+ViewMap.CONSTS.key,data:t,"async":!1,contentType:!1,processData:!1,success:function(n){n.code=="ok"&&n.result!=null&&n.result!=null?EditMode3D.GLOBAL.lstResultfile.image=n.result:swal({title:"Thông báo",text:"Không thể lưu file image",icon:"error",button:"Đóng"}).then(()=>{})},error:function(n,t,i){let r=AppCommon.getMessageErrorReuqest(n,i);console.log(r);ViewMap.showLoading(!1)}}))):swal({title:"Thông báo",text:`Vui lòng tải lên mẫu không gian 3D`,icon:"warning",button:"Đóng"})},getObjectOnThuaDat:function(){$.ajax({type:"GET",url:ViewMap.GLOBAL.url+"/v2/api/object/find",data:{maXa:ViewMap.GLOBAL.commonData.features[0].properties.MaXa,soTo:ViewMap.GLOBAL.commonData.features[0].properties.SoHieuToBanDo,soThua:ViewMap.GLOBAL.commonData.features[0].properties.SoThuTuThua,key:ViewMap.CONSTS.key},success:function(n){(n.code="ok"&&n.result!=null&&typeof n.result!="undefined")&&setTimeout(function(){for(var t=0;t<n.result.length;t++)EditMode3D.showObjectOnThuaDat(n.result[t])},1)},error:function(n,t,i){let r=AppCommon.getMessageErrorReuqest(n,i);console.log(r);ViewMap.showLoading(!1)}})},showObjectOnThuaDat:function(n){if(1){let t={id:n.id,name:n.name,tags:n.tags},i;i=typeof n.model.coordinates!="undefined"&&n.model.coordinates.length>0?new map4d.MapObject({id:n.id,scale:n.scale,coordinates:n.model.coordinates,bearing:n.bearing,elevation:n.elevation,height:n.model.height}):new map4d.MapObject({id:n.id,scale:n.scale,location:n.location,obj:n.model.objName,texture:n.model.textureName,bearing:n.bearing,elevation:n.elevation,height:n.model.height});i.setMap(mapMode3D);t.object=i;let u=map4d.PolygonOptions={paths:[n.polygon],fillOpacity:.5},r=new map4d.Polygon(u);r.setMap(mapMode3D);t.polygon=r;EditMode3D.GLOBAL.listObjectEdit.push(t)}},checkFormInfor:function(){let n=!0,t=$(EditMode3D.SELECTORS.txtNameObject).val();return validateText(t,"text",0,0)||(insertError($(EditMode3D.SELECTORS.txtNameObject),"other"),n=!1),n},updateModel3DThuaDat:function(n,t,i,r,u,f){let e={id:n,name:$(EditMode3D.SELECTORS.txtNameObject).val(),places:[],location:{lng:EditMode3D.GLOBAL.objectModel.getLocation().lng,lat:EditMode3D.GLOBAL.objectModel.getLocation().lat},scale:EditMode3D.GLOBAL.objectModel.getScale(),bearing:EditMode3D.GLOBAL.objectModel.getBearing(),elevation:EditMode3D.GLOBAL.objectModel.getElevation(),heightScale:0,camera:{zoom:0,bearing:0,tilt:0,target:{lng:0,lat:0}},model:EditMode3D.setObjectModel(),types:[],minZoom:17,maxZoom:19,addressComponents:EditMode3D.getAddressComponents(EditMode3D.GLOBAL.objectModel.getLocation().lat,EditMode3D.GLOBAL.objectModel.getLocation().lng),startDate:EditMode3D.getDataNowFromat(),endDate:null,tiles:t,address:null,tags:{area:Number($(EditMode3D.SELECTORS.txtAreaFloor).val()),floor:Number($(EditMode3D.SELECTORS.txtHeightfloor).val())},maXa:i,soTo:r,soThua:u,polygon:f};EditMode3D.showLoading(!0);$.ajax({type:"POST",url:ViewMap.GLOBAL.url+"/v2/api/object/"+n+"?key="+ViewMap.CONSTS.key,data:JSON.stringify(e),dataType:"json","async":!0,contentType:"application/json-patch+json",success:function(n){EditMode3D.showLoading(!1);n.code=="ok"?swal({title:"Thông báo",text:"Cập nhật thông tin không gian 3D thành công!",icon:"success",button:"Đóng"}).then(()=>{$(EditMode3D.SELECTORS.modalMode3D).modal("hide")}):swal({title:"Thông báo",text:"Cập nhật đã bị lỗi hệ thống!",icon:"warning",button:"Đóng"}).then(()=>{$(EditMode3D.SELECTORS.modalMode3D).modal("hide")})},error:function(n,t,i){console.log(i);EditMode3D.showLoading(!1);swal({title:"Thông báo",text:"Cập nhật đã bị lỗi hệ thống!",icon:"error",button:"Đóng"})}})},resetObject3D:function(){for(var n=0;n<EditMode3D.GLOBAL.listObjectEdit.length;n++)EditMode3D.GLOBAL.listObjectEdit[n].object.setMap(null),EditMode3D.GLOBAL.listObjectEdit[n].polygon.setMap(null);EditMode3D.GLOBAL.listObjectEdit=[]},deleteModel3D:function(n){EditMode3D.showLoading(!0);$.ajax({type:"POST",url:ViewMap.GLOBAL.url+"/v2/api/object/delete/"+n+"?key="+ViewMap.CONSTS.key,dataType:"json","async":!0,contentType:"application/json-patch+json",success:function(n){EditMode3D.showLoading(!1);n.code=="ok"?(swal({title:"Thông báo",text:"Bạn đã xóa thành công!",icon:"success",button:"Đóng"}),EditMode3D.resetPolygon()):swal({title:"Thông báo",text:"Xóa đã lỗi hệ thống!",icon:"warning",button:"Đóng"})},error:function(n){console.log(n);EditMode3D.showLoading(!1);swal({title:"Thông báo",text:"Không xóa được vì lỗi hệ thống.",icon:"error",button:"Đóng"})}})},showLoading:function(n){n?$(EditMode3D.SELECTORS.loadingModel3D).show():$(EditMode3D.SELECTORS.loadingModel3D).hide()}};