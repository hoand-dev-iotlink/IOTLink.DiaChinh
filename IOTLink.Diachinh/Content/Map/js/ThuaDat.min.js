var ViewMap={GLOBAL:{ThuaDatSelect:null,location:null,url:"https://api-fiolis.map4d.vn",commonData:{},lstSearch:null,latLngDefault:{lat:10.678087311284315,lng:105.08063708265138},zoomDefault:16},CONSTS:{codeDefault:"001001003003",key:"8bd33b7fd36d68baa96bf446c84011da",MinDefault:18},SELECTORS:{menuright:".menu-right",menuclick:".location-click",addressClick:".address-menu-click",locationClick:".location-menu-click",locationClickVN2000:".location-menu-click-vn2000",closeClick:".close-content",loading:"#loading-map",inforThuaDat:"#InforThuaDat",SoToBD:".SoToBD",SoThuaBD:".SoThuaBD",SoToOld:".SoToOld",SoThuaOld:".SoThuaOld",DientichBD:".DientichBD",DientichPL:".DientichPL",MucDichSuDung:".MucDichSuDung",NameMucDichSuDung:".NameMucDichSuDung",KHDTC:".KHDTC",TenChu:".TenChu",DiaChi:".DiaChi",MaXa:".MaXa",searchtext:".search-text",idsearchtext:"#id-search-text",tooltipsearch:"#tooltip-search",tooltipsearchsetting:"#tooltip-searchsetting",tooltipsearchadvance:"#tooltip-search-adv",tooltiptext:".tooltiptext",tooltiptextsetting:".tooltiptextsetting",clearinputid:".clear-input-id",advSearch:"#advSearch",SoToSearch:"#text-search-soTo",SoThuaSearch:"#text-search-soThua",MucDichSuDungSearch:"#text-search-MDSuDung",TenChuSearch:"#text-search-chuNha",DiaChiSearch:"#text-search-diaChi",listSearchAdv:"#list-search-adv",lstSelectSearch:"#lstSelectSearch-adv",loadingInfoThuaDat:"#loading-map-infoThuaDat"},init:function(){document.oncontextmenu=document.body.oncontextmenu=function(){return!1};map=new map4d.Map(document.getElementById("map"),{zoom:ViewMap.GLOBAL.zoomDefault,center:ViewMap.GLOBAL.latLngDefault,geolocate:!0,minZoom:3,maxZoom:22,tilt:0,controls:!0,controlOptions:map4d.ControlOptions.BOTTOM_RIGHT,accessKey:"208e1c99aa440d8bc2847aafa3bc0669"});map.setTileUrl("http://61.28.233.229:8080/all/2d/{z}/{x}/{y}.png");map.setTileUrl("http://61.28.233.229:8080/all/3d/{z}/{x}/{y}.png",!0);map.setPlacesEnabled(!1);ViewMap.SetEvent()},SetEvent:function(){let n=map.data.addListener("click",n=>{let t=map.getCamera(),i=t.getZoom();ViewMap.CONSTS.MinDefault<=i?ToolShape.GLOBAL.isStartArea||ToolShape.GLOBAL.isStartDistance||HopThua.GLOBAL.checkHopThua||(ViewMap.showHideMenuClick(!1,null),ViewMap.showHideMenu(!1,null),setTimeout(function(){ViewMap.getInforThuaDat(n.location.lat,n.location.lng)},1)):swal({title:"Thông báo",text:"Bạn cần phải zoom to hơn nữa để hiển thị chi tiết lô đất",icon:"warning",button:"Đóng"})});map.addListener("rightClick",n=>{ViewMap.showHideMenuClick(!1,null),ViewMap.removeSelectThuaDat(),ViewMap.getLocationMap(n.location.lat,n.location.lng,!1)});map.addListener("cameraChanging",()=>{ViewMap.showHideMenu(!1,null)});map.addListener("click",()=>{ViewMap.showHideMenu(!1,null)});map.addListener("click",n=>{ViewMap.showHideMenuClick(!1,null),ViewMap.removeSelectThuaDat(),n!=null&&n.location!=null&&(ViewMap.getConvertVN2000(n.location.lat,n.location.lng),ViewMap.getLocationMap(n.location.lat,n.location.lng,!0),ViewMap.SetMarkerLocation(n.location.lat,n.location.lng,!0),ViewMap.showHideViewProperty(!1))},{location:!0});$(ViewMap.SELECTORS.closeClick).click(function(){ViewMap.SetMarkerLocation(0,0,!1);ViewMap.showHideMenuClick(!1,null)});$(ViewMap.SELECTORS.inforThuaDat).find(".toggle-detail-property").on("click",function(){$(ViewMap.SELECTORS.inforThuaDat).toggleClass("detail-property-collapse");ViewMap.removeSelectThuaDat()});$(ViewMap.SELECTORS.tooltipsearch).hover(function(){$(ViewMap.SELECTORS.tooltiptext).css({visibility:"inherit"})});$(ViewMap.SELECTORS.tooltipsearch).mouseout(function(){$(ViewMap.SELECTORS.tooltiptext).css({visibility:"hidden"})});$(ViewMap.SELECTORS.tooltipsearch).click(function(){var t=$(ViewMap.SELECTORS.searchtext).val(),n=t.split(",");n.length===2&&($(ViewMap.SELECTORS.advSearch).removeClass("advSearchIndex"),ViewMap.getInfoSearch(n[0],n[1],"","","",ViewMap.CONSTS.codeDefault),$(ViewMap.SELECTORS.SoToSearch).val(parseInt(n[0])),$(ViewMap.SELECTORS.SoThuaSearch).val(parseInt(n[1])))});$(ViewMap.SELECTORS.tooltipsearchadvance).click(function(){var n=$(ViewMap.SELECTORS.SoToSearch).val(),t=$(ViewMap.SELECTORS.SoThuaSearch).val(),i=$(ViewMap.SELECTORS.DiaChiSearch).val(),r=$(ViewMap.SELECTORS.TenChuSearch).val(),u=$(ViewMap.SELECTORS.MucDichSuDungSearch).val();if(n>0&&t>0||n!==""&&t!==""){ViewMap.getInfoSearch(n,t,i,r,u,$(ViewMap.SELECTORS.lstSelectSearch).val());return}if(i!==""||r!==""||u!==""){ViewMap.getInfoSearch(n,t,i,r,u,$(ViewMap.SELECTORS.lstSelectSearch).val());return}swal({title:"Thông báo",text:"Dữ liệu nhập không đúng",icon:"warning",button:"Đóng"}).then(()=>{})});$(ViewMap.SELECTORS.tooltipsearchsetting).hover(function(){$(ViewMap.SELECTORS.tooltiptextsetting).css({visibility:"inherit"})});$(ViewMap.SELECTORS.tooltipsearchsetting).mouseout(function(){$(ViewMap.SELECTORS.tooltiptextsetting).css({visibility:"hidden"})});$(ViewMap.SELECTORS.tooltipsearchsetting).click(function(){$(ViewMap.SELECTORS.listSearchAdv).html("");$(ViewMap.SELECTORS.SoToSearch).val(null);$(ViewMap.SELECTORS.SoThuaSearch).val(null);$(ViewMap.SELECTORS.MucDichSuDungSearch).val(null);$(ViewMap.SELECTORS.TenChuSearch).val(null);$(ViewMap.SELECTORS.DiaChiSearch).val(null);$(ViewMap.SELECTORS.lstSelectSearch).val(ViewMap.CONSTS.codeDefault);$(ViewMap.SELECTORS.advSearch).hasClass("advSearchIndex")?$(ViewMap.SELECTORS.advSearch).removeClass("advSearchIndex"):$(ViewMap.SELECTORS.advSearch).addClass("advSearchIndex")});$(document).on("click","#showlstsearch",function(){var t=parseInt($(this).attr("data-thua")),i=parseInt($(this).attr("data-to")),n=ViewMap.GLOBAL.lstSearch.find(n=>n.properties.SoThuTuThua===t&&n.properties.SoHieuToBanDo===i);if(n!==null&&n!==undefined){ViewMap.GLOBAL.commonData=n;EditMode3D.resetObject3D();let t=n.properties;$(ViewMap.SELECTORS.MaXa).text(t.MaXa);$(ViewMap.SELECTORS.TenChu).text(t.TenChu);$(ViewMap.SELECTORS.DiaChi).text(t.DiaChi);$(ViewMap.SELECTORS.SoThuaBD).text(t.SoThuTuThua);$(ViewMap.SELECTORS.SoToBD).text(t.SoHieuToBanDo);$(ViewMap.SELECTORS.SoThuaOld).text(t.SoThuTuThuaCu!=null?t.SoThuTuThuaCu:0);$(ViewMap.SELECTORS.SoToOld).text(t.SoHieuToBanDoCu!=null?t.SoHieuToBanDoCu:0);$(ViewMap.SELECTORS.DientichBD).text(t.DienTich);$(ViewMap.SELECTORS.DientichPL).text(t.DienTichPhapLy);$(ViewMap.SELECTORS.KHDTC).text(t.KyHieuDoiTuong);$(ViewMap.SELECTORS.MucDichSuDung).text(t.KyHieuMucDichSuDung);$(ViewMap.SELECTORS.NameMucDichSuDung).text(t.TenMucDichSuDung);ViewMap.showHideViewProperty(!0);ViewMap.setSelectThuaDatSearch(n);UpdateUrl(null,null,null,null,t.SoHieuToBanDo,t.SoThuTuThua)}});$(ViewMap.SELECTORS.searchtext).click(function(){var n=document.getElementById("id-search-text");n.focus()});$(ViewMap.SELECTORS.searchtext).blur(function(){$(this).val==="_,_"&&$(ViewMap.SELECTORS.searchtext).val("")});$(ViewMap.SELECTORS.searchtext).hover(function(){$(ViewMap.SELECTORS.searchtext).attr("placeholder","_,_")});$(ViewMap.SELECTORS.searchtext).mouseout(function(){$(ViewMap.SELECTORS.searchtext).attr("placeholder","Số tờ, Số thửa")});$(ViewMap.SELECTORS.searchtext).keyup(function(n){var i=$(this).val(),t=i.split(","),r;if(t.length===1&&(i.length>5||n.keyCode===32)&&$(this).val(i.slice(0,5)+","+i.slice(5)),n.keyCode===13&&$(ViewMap.SELECTORS.tooltipsearch).click(),t.length>2){for(r=2;r<t.length;r++)t[1]+=t[r];$(this).val(t[0]+","+t[1])}});Array.prototype.forEach.call(document.querySelectorAll(".clearable-input"),function(n){function i(n){var i=n&&n.target||t;i.nextElementSibling.style.display=i.value?"block":"none"}var t=n.querySelector("input");i();t.addEventListener("input",i);n.querySelector("[data-clear-input]").addEventListener("click",function(){t.value="";i();$(ViewMap.SELECTORS.advSearch).removeClass("advSearchIndex")})});map.addListener("idle",n=>{setTimeout(function(){UpdateUrl(n.camera.getTarget().lat,n.camera.getTarget().lng,n.camera.getZoom(),null,null,null)})})},setSelectThuaDat:function(n){if(ViewMap.removeSelectThuaDat(),ViewMap.GLOBAL.ThuaDatSelect==null){geometry=n.geometry;let i=ViewMap.getCoordinatesSearch(geometry),r=[];for(var t=0;t<i.length;t++)polyline=new map4d.Polyline({path:i[t],strokeColor:"#00ffff",strokeOpacity:1,strokeWidth:2}),polyline.ObjectId=n.properties.ObjectId,polyline.setMap(map),r.push(polyline);ViewMap.GLOBAL.ThuaDatSelect=r}},removeSelectThuaDat:function(){typeof ViewMap.GLOBAL.ThuaDatSelect!="undefined"&&ViewMap.GLOBAL.ThuaDatSelect!=null&&ViewMap.GLOBAL.ThuaDatSelect.length>0&&$.each(ViewMap.GLOBAL.ThuaDatSelect,function(n,t){t.setMap(null)});ViewMap.GLOBAL.ThuaDatSelect=null},drawThuaDat:function(){},checkJson:function(n){try{return jsonResult=JSON.parse(n),!0}catch(t){return!1}},showHideMenu:function(n,t){if(n){let n=t.y+"px",i=t.x+"px";$(ViewMap.SELECTORS.menuright).css({display:"block",left:i,top:n})}else $(ViewMap.SELECTORS.menuright).css({display:"none"})},showHideMenuClick:function(n){n?$(ViewMap.SELECTORS.menuclick).css({display:"flex"}):($(ViewMap.SELECTORS.addressClick).text(""),$(ViewMap.SELECTORS.locationClick).text(""),$(ViewMap.SELECTORS.menuclick).css({display:"none"}),ViewMap.SetMarkerLocation(0,0,!1))},addDataLocation:function(n){$(ViewMap.SELECTORS.addressClick).text(n.str);$(ViewMap.SELECTORS.locationClick).text(n.lat+", "+n.lng);ViewMap.showHideMenuClick(!0)},getLocationMap:function(n,t,i){$.ajax({type:"GET",url:ViewMap.GLOBAL.url+"/v2/api/admin-level/latlng",data:{lat:n,lng:t,key:ViewMap.CONSTS.key},"async":!1,success:function(r){var u,f;if(r.result.length>0){let e="";for(u=r.result.length-1;u>=0;u--){let n=r.result[u];e+=n.name;u>0&&(e+=", ")}f={str:e,lat:n,lng:t};i&&ViewMap.addDataLocation(f);ViewMap.GLOBAL.location={data:r.result,lat:n,lng:t}}},error:function(n,t,i){let r=AppCommon.getMessageErrorReuqest(n,i);console.log(r)}})},getConvertVN2000:function(n,t){$.ajax({type:"GET",url:ViewMap.GLOBAL.url+"/v2/api/admin-level/wgs84-vn2000",data:{lat:n,lng:t,key:ViewMap.CONSTS.key},success:function(n){if(n.code=="ok"&&n.result!=null&&typeof n.result!=undefined){let t=Math.round(n.result.x*1e3)/1e3,i=Math.round(n.result.y*1e3)/1e3;$(ViewMap.SELECTORS.locationClickVN2000).text(t+", "+i)}},error:function(n,t,i){let r=AppCommon.getMessageErrorReuqest(n,i);console.log(r)}})},getThuaDatbyCode:function(n){ViewMap.showLoading(!0);$.ajax({type:"GET",url:ViewMap.GLOBAL.url+"/v2/api/land/code",data:{code:n,key:ViewMap.CONSTS.key},success:function(t){t.result!=null&&typeof t.result!="undefined"?t.result.features.length>0?(map.data.clear(),ViewMap.drawThuaDat(t.result),ViewMap.showLoading(!1),ViewMap.CONSTS.codeDefault=n):(ViewMap.showLoading(!1),bootbox.alert("Phường/Xã này chưa có dữ liệu")):(ViewMap.showLoading(!1),bootbox.alert("Lỗi hệ thông"))},error:function(n,t,i){let r=AppCommon.getMessageErrorReuqest(n,i);console.log(r);ViewMap.showLoading(!1)}})},SetMarkerLocation:function(n,t,i){typeof markerClick!="undefined"&&markerClick!=null&&markerClick.setMap(null);i&&(markerClick=new map4d.Marker({position:{lat:n,lng:t},icon:new map4d.Icon(26,32,"https://api.map4d.vn/v2/api/place/icon?option=1&type=lodging&size=1x&key=208e1c99aa440d8bc2847aafa3bc0669"),anchor:[.5,.9]}),markerClick.setMap(map))},showThuaDatSelectSubdistrict:function(){var t,i;ViewMap.CONSTS.codeDefault=ViewMap.GLOBAL.location.data[ViewMap.GLOBAL.location.data.length-1].code;setTimeout(function(){ViewMap.getThuaDatbyCode(ViewMap.CONSTS.codeDefault)});ViewMap.showHideMenu(!1,null);let n=ViewMap.GLOBAL.location.data[ViewMap.GLOBAL.location.data.length-1].id;MenuLeft.GLOBAL.idSelect!=null&&MenuLeft.GLOBAL.idSelect!=""&&(t=document.getElementById(MenuLeft.GLOBAL.idSelect),t.style.background="");$("[data-code="+ViewMap.CONSTS.codeDefault+"]").css("background","");i=document.getElementById(n);i.style.background="rgba(33, 152, 241, 0.3)";MenuLeft.GLOBAL.idSelect=n},showLoading:function(n){n?$(ViewMap.SELECTORS.loading).show():$(ViewMap.SELECTORS.loading).hide()},getCoordinates:function(n){let i=[],r=n.getAt(0).getLength();for(var t=0;t<r;t++){let r=n.getAt(0).getAt(t)._elements;i.push(r)}return i},getInforThuaDat:function(n,t){ViewMap.showLoadingInfoThuaDat(!0);$.ajax({type:"GET",url:ViewMap.GLOBAL.url+"/v2/api/land/latlng",data:{lat:n,lng:t,key:ViewMap.CONSTS.key},success:function(n){if(ViewMap.GLOBAL.commonData=n.result,EditMode3D.resetObject3D(),n.code=="ok"&&n.result!=null&&n.result.features.length>0&&n.result.capHanhChinh.length>0){let t=n.result.features[0].properties;$(ViewMap.SELECTORS.MaXa).text(t.MaXa);$(ViewMap.SELECTORS.TenChu).text(t.TenChu);$(ViewMap.SELECTORS.DiaChi).text(t.DiaChi);$(ViewMap.SELECTORS.SoThuaBD).text(t.SoThuTuThua);$(ViewMap.SELECTORS.SoToBD).text(t.SoHieuToBanDo);$(ViewMap.SELECTORS.SoThuaOld).text(t.SoThuTuThuaCu!=null?t.SoThuTuThuaCu:0);$(ViewMap.SELECTORS.SoToOld).text(t.SoHieuToBanDoCu!=null?t.SoHieuToBanDoCu:0);$(ViewMap.SELECTORS.DientichBD).text(t.DienTich);$(ViewMap.SELECTORS.DientichPL).text(t.DienTichPhapLy);$(ViewMap.SELECTORS.KHDTC).text(t.KyHieuDoiTuong);$(ViewMap.SELECTORS.MucDichSuDung).text(t.KyHieuMucDichSuDung);$(ViewMap.SELECTORS.NameMucDichSuDung).text(t.TenMucDichSuDung);ViewMap.showHideViewProperty(!0);ViewMap.setSelectThuaDat(n.result.features[0]);UpdateUrl(null,null,null,n.result.capHanhChinh[n.result.capHanhChinh.length-1].code,t.SoHieuToBanDo,t.SoThuTuThua)}else swal({title:"Thông báo",text:"Không tìm thấy kết quả",icon:"error",button:"Đóng"}).then(()=>{});ViewMap.showLoadingInfoThuaDat(!1)},error:function(n,t,i){let r=AppCommon.getMessageErrorReuqest(n,i);console.log(r);ViewMap.showLoadingInfoThuaDat(!1)}})},showHideViewProperty:function(n){n?$(ViewMap.SELECTORS.inforThuaDat).removeClass("detail-property-collapse"):($(ViewMap.SELECTORS.inforThuaDat).addClass("detail-property-collapse"),RemoveUrlToThua())},getInfoSearch:function(n,t,i,r,u,f){ViewMap.showLoadingInfoThuaDat(!0);$.ajax({type:"GET",url:ViewMap.GLOBAL.url+"/v2/api/land/find",data:{code:f,soTo:n,soThua:t,diaChi:i,tenChu:r,kyHieuMucDichSuDung:u,key:ViewMap.CONSTS.key},success:function(n){if(n.code=="ok"&&n.result!=null&&n.result.features.length>0)if(n.result.features.length===1){EditMode3D.resetObject3D();let t=n.result.features[0].properties;$(ViewMap.SELECTORS.MaXa).text(t.MaXa);$(ViewMap.SELECTORS.TenChu).text(t.TenChu);$(ViewMap.SELECTORS.DiaChi).text(t.DiaChi);$(ViewMap.SELECTORS.SoThuaBD).text(t.SoThuTuThua);$(ViewMap.SELECTORS.SoToBD).text(t.SoHieuToBanDo);$(ViewMap.SELECTORS.SoThuaOld).text(t.SoThuTuThuaCu!=null?t.SoThuTuThuaCu:0);$(ViewMap.SELECTORS.SoToOld).text(t.SoHieuToBanDoCu!=null?t.SoHieuToBanDoCu:0);$(ViewMap.SELECTORS.DientichBD).text(t.DienTich);$(ViewMap.SELECTORS.DientichPL).text(t.DienTichPhapLy);$(ViewMap.SELECTORS.KHDTC).text(t.KyHieuDoiTuong);$(ViewMap.SELECTORS.MucDichSuDung).text(t.KyHieuMucDichSuDung);$(ViewMap.SELECTORS.NameMucDichSuDung).text(t.TenMucDichSuDung);ViewMap.showHideViewProperty(!0);ViewMap.setSelectThuaDatSearch(n.result.features[0]);UpdateUrl(null,null,null,null,t.SoHieuToBanDo,t.SoThuTuThua)}else{ViewMap.GLOBAL.lstSearch=n.result.features;let i='<div class="form-content" id = "style-3">';for(var t=0;t<ViewMap.GLOBAL.lstSearch.length;t++)i+=`
                                <div class="row-item" style="height: 100%;position: relative;">
                                    <div class="item" data-id = "${ViewMap.GLOBAL.lstSearch[t].properties.SoThuTuThua}">
                                                <div class="route-no">
                                                    <span class="font-light ng-binding">${t+1}</span>
                                                </div>
                                     </div>
                                     <div class="item-route item" style="width:70%" title = "Xem chi tiết">
                                            <div class="" style="">
                                                    <div class="font-bold ng-binding" style = "font-weight: 700; color: #000"> ${ViewMap.GLOBAL.lstSearch[t].properties.TenChu}</div>
                                            </div>
                                            <div class="" style="overflow: hidden;">
                                                    <div class="font-normal ng-binding" style ="color: #000">Số tờ ${ViewMap.GLOBAL.lstSearch[t].properties.SoHieuToBanDo}- Số thừa :${ViewMap.GLOBAL.lstSearch[t].properties.SoThuTuThua}</div>
                                            </div>
                                      </div>
                                <div class="item">
                                    <button class="btn" title= "Xem chi tiết" type="button" id="showlstsearch" style="background: beige;" data-thua ="${ViewMap.GLOBAL.lstSearch[t].properties.SoThuTuThua}" data-to="${ViewMap.GLOBAL.lstSearch[t].properties.SoHieuToBanDo}">
                                        <i class="fa fa-arrow-right"></i>
                                    </button>
                                </div>
                                </div>`;i+=`</div>`;$(ViewMap.SELECTORS.listSearchAdv).html("");$(ViewMap.SELECTORS.listSearchAdv).append(i);$(ViewMap.SELECTORS.advSearch).addClass("advSearchIndex")}else swal({title:"Thông báo",text:"Không tìm thấy kết quả",icon:"warning",button:"Đóng"}).then(()=>{});ViewMap.showLoadingInfoThuaDat(!1)},error:function(n,t,i){let r=AppCommon.getMessageErrorReuqest(n,i);console.log(r);ViewMap.showLoadingInfoThuaDat(!1)}})},setSelectThuaDatSearch:function(n){var t,i;if(ViewMap.removeSelectThuaDat(),ViewMap.GLOBAL.ThuaDatSelect==null){geometry=n.geometry;let r=ViewMap.getCoordinatesSearch(geometry),u=[];for(t=0;t<r.length;t++)polyline=new map4d.Polyline({path:r[t],strokeColor:"#00ffff",strokeOpacity:1,strokeWidth:2}),polyline.setMap(map),polyline.ObjectId=n.properties.ObjectId,u.push(polyline);ViewMap.GLOBAL.ThuaDatSelect=u;let f=new map4d.LatLngBounds;for(i=0;i<r[0].length;i++)f.extend(r[0][i]);map.fitBounds(f,{top:10,bottom:10,left:10,right:10},null)}},getCoordinatesSearch:function(n){let i=[];if(n.type==="Polygon"){let t=n.coordinates.length;return n.coordinates}if(n.type==="MultiPolygon"){let r=n.coordinates[0].length;for(var t=0;t<r;t++){let r=n.coordinates[0][t];i.push(r)}return i}},showLoadingInfoThuaDat:function(n){n?$(ViewMap.SELECTORS.loadingInfoThuaDat).show():$(ViewMap.SELECTORS.loadingInfoThuaDat).hide()},getVN2000ThuaDat:function(n,t,i){$.ajax({type:"GET",url:ViewMap.GLOBAL.url+"/v2/api/land/find-info",data:{code:i,soTo:n,soThua:t,key:ViewMap.CONSTS.key},"async":!0,success:function(n){n.result!==null&&typeof n.result!="undefined"?ViewMap.GLOBAL.commonData=n.result:bootbox.alert("Lỗi hệ thống")},error:function(n,t,i){let r=AppCommon.getMessageErrorReuqest(n,i);console.log(r);ViewMap.showLoading(!1)}})}};