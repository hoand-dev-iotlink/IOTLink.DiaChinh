var ToolShape={GLOBAL:{isStartDistance:!1,isStartArea:!1,listDistance:{listMarkerDistance:[],listPolylineDistance:[],listMerterDistance:[]},listArea:{listMarkerArea:[],listMerterArea:[],polygonArea:null,PolylineArea:null},polylineTemp:null},CONSTS:{},SELECTORS:{btnExportFile:".btn-export-file",btnPrint:".btn-print",btnUpdateFile:".btn-update-file",btnUpdateShape:".btn-update-shape",btnRuleDistance:".draw-width-height",btnRuleArea:".draw-area",btnRuleReplay:".draw-replay",btnExportMultiFile:".btn-export-multi-file",btnDownloadFile:".btn-download-file",modalTrichXuat:".modal-trich-xuat",inputMaXa:"input[name='MaXa']",selectVungSoTo:"select[name='VungSoTo']",selectVungSoThua:"select[name='VungSoThua']",inputSoTo:"input[name='SoTo']",inputSoThua:"input[name='SoThua']",inputCommon:".common-so input"},init:function(){ToolShape.setEvent()},setEvent:function(){listMarkerDrawLoDat=[];listDataFloor=[{objectId:"default",objectModel:null,polygon:null,marker:[],area:0}];markerMeter=null;$(ToolShape.SELECTORS.btnExportFile).on("click",function(){ToolShape.selectExportFileShape()});$(ToolShape.SELECTORS.btnRuleDistance).on("click",function(){ToolShape.GLOBAL.isStartDistance||ToolShape.setShowHideDistance(!0);$(ViewMap.SELECTORS.inforThuaDat).addClass("detail-property-collapse");ViewMap.removeSelectThuaDat()});$(ToolShape.SELECTORS.btnRuleArea).on("click",function(){ToolShape.GLOBAL.isStartArea||ToolShape.setShowHideArea(!0);$(ViewMap.SELECTORS.inforThuaDat).addClass("detail-property-collapse");ViewMap.removeSelectThuaDat()});$(ToolShape.SELECTORS.btnRuleReplay).on("click",function(){ToolShape.replayRuleShape()});$(ToolShape.SELECTORS.btnExportMultiFile).on("click",function(){$(ToolShape.SELECTORS.modalTrichXuat).modal("show");let n=ViewMap.GLOBAL.commonData;$(ToolShape.SELECTORS.inputMaXa).val(n.features[0].properties.MaXa)});$(ToolShape.SELECTORS.inputCommon).on("focus",function(){insertError($(this),"remove")});let n=map.addListener("mouseMove",n=>{if(ToolShape.GLOBAL.isStartDistance&&ToolShape.GLOBAL.listDistance.listMarkerDistance.length>0){let i=[],t=ToolShape.GLOBAL.listDistance.listMarkerDistance,r=[t[t.length-1].getPosition().lng,t[t.length-1].getPosition().lat],u=[n.location.lng,n.location.lat];i.push(r);i.push(u);ToolShape.createPolylineByMouseMoveLoDat(i,3,.7);ToolShape.ShowMeterDraw(r,u,!0)}if(ToolShape.GLOBAL.isStartArea&&ToolShape.GLOBAL.listArea.listMarkerArea.length>0){let i=[],t=ToolShape.GLOBAL.listArea.listMarkerArea,r=[t[t.length-1].getPosition().lng,t[t.length-1].getPosition().lat],u=[n.location.lng,n.location.lat];i.push(r);i.push(u);ToolShape.createPolylineByMouseMoveLoDat(i,3,.7);ToolShape.ShowMeterDraw(r,u,!0)}ToolShape.GLOBAL.isStartDistance||ToolShape.GLOBAL.isStartArea||ToolShape.GLOBAL.polylineTemp==null||ToolShape.GLOBAL.polylineTemp.setMap(null)}),t=map.addListener("click",n=>{if(ToolShape.GLOBAL.isStartDistance&&(ToolShape.createMarkerDrawLoDat(n.location.lat,n.location.lng,!1),ToolShape.GLOBAL.listDistance.listMarkerDistance.length>1)){let n=[];$.each(ToolShape.GLOBAL.listDistance.listMarkerDistance,function(){let t={lat:this.getPosition().lat,lng:this.getPosition().lng};n.push(t)});ToolShape.createPolylineLoDat(n,3,1,!0)}if(ToolShape.GLOBAL.isStartArea&&(ToolShape.createMarkerDrawLoDat(n.location.lat,n.location.lng,!0),ToolShape.GLOBAL.listArea.listMarkerArea.length>1)){let n=[];$.each(ToolShape.GLOBAL.listArea.listMarkerArea,function(){let t={lat:this.getPosition().lat,lng:this.getPosition().lng};n.push(t)});n.push(n[0]);ToolShape.createPolygonArea(n)}},{map:!0}),i=map.addListener("dblClick",n=>{if(ToolShape.GLOBAL.isStartDistance){ToolShape.GLOBAL.isStartDistance=!1;let i=ToolShape.GLOBAL.listDistance.listMerterDistance,t=0;$.each(i,function(n,i){i.setMap(map);let r=i.getLabel().text;t+=ToolShape.splitStringDistance(r)});let r=n.location;t=Math.round(t*100)/100;ToolShape.showMerterTotal(r,t)}if(ToolShape.GLOBAL.isStartArea){ToolShape.GLOBAL.isStartArea=!1;ToolShape.GLOBAL.isStartDistance=!1;let n=ToolShape.GLOBAL.listArea.listMerterArea;$.each(n,function(n,t){t.setMap(map)});ToolShape.GLOBAL.listArea.polygonArea!=null&&typeof ToolShape.GLOBAL.listArea.polygonArea!=undefined&&ToolShape.showMerterTotalArea()}},{marker:!0}),r=map.addListener("click",n=>{if(ToolShape.GLOBAL.isStartDistance){ToolShape.createMarkerDrawLoDat(n.location.lat,n.location.lng,!1);let i=ToolShape.GLOBAL.listDistance.listMarkerDistance,t=[];if($.each(i,function(n,i){let r={lat:i.getPosition().lat,lng:i.getPosition().lng};t.push(r)}),t.length>1){let n=[t[t.length-2].lng,t[t.length-2].lat],i=[t[t.length-1].lng,t[t.length-1].lat];ToolShape.ShowMeterDraw(n,i,!1)}ToolShape.createPolylineLoDat(t,3,1,!0)}if(ToolShape.GLOBAL.isStartArea){ToolShape.createMarkerDrawLoDat(n.location.lat,n.location.lng,!0);let t=[];if(ToolShape.GLOBAL.listArea.listMarkerArea.length==2){let n=ToolShape.GLOBAL.listArea.listMarkerArea;$.each(n,function(){let n={lng:this.getPosition().lng,lat:this.getPosition().lat};t.push(n)});let i=[t[t.length-2].lng,t[t.length-2].lat],r=[t[t.length-1].lng,t[t.length-1].lat];ToolShape.ShowMeterArea(i,r);ToolShape.createPolylineLoDat(t,3,1,!1)}else if(ToolShape.GLOBAL.listArea.listMarkerArea.length>2){let n=ToolShape.GLOBAL.listArea.listMarkerArea;$.each(n,function(){let n={lng:this.getPosition().lng,lat:this.getPosition().lat};t.push(n)});let i=[t[t.length-2].lng,t[t.length-2].lat],r=[t[t.length-1].lng,t[t.length-1].lat];ToolShape.ShowMeterArea(i,r);t.push(t[0]);ToolShape.createPolygonArea(t);ToolShape.GLOBAL.listArea.PolylineArea!=null&&(ToolShape.GLOBAL.listArea.PolylineArea.setMap(null),ToolShape.GLOBAL.listArea.PolylineArea=null)}}},{polyline:!0}),u=map.data.addListener("click",n=>{if(ToolShape.GLOBAL.isStartDistance&&(ToolShape.createMarkerDrawLoDat(n.location.lat,n.location.lng,!1),ToolShape.GLOBAL.listDistance.listMarkerDistance.length>1)){let n=[];$.each(ToolShape.GLOBAL.listDistance.listMarkerDistance,function(){let t={lat:this.getPosition().lat,lng:this.getPosition().lng};n.push(t)});ToolShape.createPolylineLoDat(n,3,1,!0)}if(ToolShape.GLOBAL.isStartArea&&(ToolShape.createMarkerDrawLoDat(n.location.lat,n.location.lng,!0),ToolShape.GLOBAL.listArea.listMarkerArea.length>1)){let n=[];$.each(ToolShape.GLOBAL.listArea.listMarkerArea,function(){let t={lat:this.getPosition().lat,lng:this.getPosition().lng};n.push(t)});n.push(n[0]);ToolShape.createPolygonArea(n)}})},selectExportFileShape:function(){bootbox.prompt({title:"Chọn file cần trích xuất",inputType:"select",inputOptions:[{text:"Shape file",value:"SHP"},{text:"KML",value:"KML"},{text:"Text file",value:"TXT"}],callback:function(n){n!=null&&ToolShape.exportFileShape(n)}})},exportFileShape:function(n){if(ViewMap.GLOBAL.ThuaDatSelect!=null){var i=ViewMap.GLOBAL.ThuaDatSelect,r=i[0].ObjectId,t=ToolShape.getShapeVN2000(r);switch(n){case"TXT":ToolShape.getExportFileTxt(JSON.stringify(t),n);break;case"SHP":ToolShape.getExportFileShape(JSON.stringify(t),n);break;case"KML":ToolShape.getExportFileShape(JSON.stringify(t),n)}}},getShapeVN2000:function(n){var t;return $.ajax({type:"GET",url:ViewMap.GLOBAL.url+"/v2/api/land/find-info",data:{code:ViewMap.CONSTS.codeDefault,objectId:n,key:ViewMap.CONSTS.key},"async":!1,success:function(n){if(console.log(n),n.code=="ok"&&n.result.features!=null&&n.result.features.length>0){var i=[];$.each(n.result.features,function(n,t){t.properties.info==="vn2000"&&i.push(t)});t={type:"FeatureCollection",features:i}}},error:function(n,t,i){let r=AppCommon.getMessageErrorReuqest(n,i);console.log(r)}}),t},getExportFileShape:function(n,t){var i={category:t,shapeJson:n};$.ajax({url:"/Home/ExportFileShape",type:"POST",data:JSON.stringify(i),contentType:"application/json",dataType:"json","async":!0,success:function(n){n.code?window.location=`/Home/DownloadFile?filePath=${n.result}&type=${t}`:bootbox.alert("Dữ liệu không hợp lệ")},error:function(n,t,i){let r=AppCommon.getMessageErrorReuqest(n,i);console.log(r)}})},getExportFileTxt:function(n){var t=Date.parse(new Date);$("<a />",{download:"ThuaDat_"+t+".txt",href:"data:application/json;charset=utf-8,"+encodeURIComponent(n)}).appendTo("body").click(function(){$(this).remove()})[0].click()},createPolylineByMouseMoveLoDat:function(n,t,i){ToolShape.GLOBAL.polylineTemp!=null&&ToolShape.GLOBAL.polylineTemp.setMap(null);ToolShape.GLOBAL.polylineTemp=new map4d.Polyline({path:n,visible:!0,strokeColor:"#FF8264",strokeWidth:t,strokeOpacity:i,closed:!1});ToolShape.GLOBAL.polylineTemp.setMap(map)},ShowMeterDraw:function(n,t,i){let r=new map4d.Projection(map),u=r.fromLatLngToScreen([n[0],n[1]]),f=r.fromLatLngToScreen([t[0],t[1]]),o=(u.x+f.x)/2,s=(u.y+f.y)/2,e=r.fromScreenToLatLng({x:o,y:s}),h=new map4d.Measure([n,t,]),c=(Math.round(h.length*100)/100).toString();i?(markerMeter!=null&&markerMeter.setMap(null),markerMeter=new map4d.Marker({position:{lat:e.lat,lng:e.lng},anchor:[.5,1],visible:!0,label:new map4d.MarkerLabel({text:c+" m",color:"000000",fontSize:12}),icon:new map4d.Icon(32,32,"")}),markerMeter.setMap(map)):(ToolShape.GLOBAL.listDistance.listMerterDistance.push(markerMeter),markerMeter!=null&&markerMeter.setMap(null))},ShowMeterArea:function(n,t){let i=new map4d.Projection(map),r=i.fromLatLngToScreen([n[0],n[1]]),u=i.fromLatLngToScreen([t[0],t[1]]),e=(r.x+u.x)/2,o=(r.y+u.y)/2,f=i.fromScreenToLatLng({x:e,y:o}),s=new map4d.Measure([n,t,]),h=(Math.round(s.length*100)/100).toString();markerMeter!=null&&markerMeter.setMap(null);markerMeter=new map4d.Marker({position:{lat:f.lat,lng:f.lng},anchor:[.5,.5],visible:!0,label:new map4d.MarkerLabel({text:h+" m",color:"000000",fontSize:11}),icon:new map4d.Icon(32,32,"")});markerMeter.setMap(map);ToolShape.GLOBAL.listArea.listMerterArea.push(markerMeter);markerMeter!=null&&markerMeter.setMap(null)},showMerterTotal:function(n,t){let r=new map4d.Projection(map),i=null;i=new map4d.Marker({position:{lat:n.lat,lng:n.lng},anchor:[.5,.5],visible:!0,label:new map4d.MarkerLabel({text:t+" m",color:"000000",fontSize:11}),icon:new map4d.Icon(32,32,"")});i.setMap(map);ToolShape.GLOBAL.listDistance.listMerterDistance.push(i)},showMerterTotalArea:function(){var n=ToolShape.calculatorAraePolygon(ToolShape.GLOBAL.listArea.polygonArea.getPaths()[0]);n=Math.round(n*100)/100;let r=new map4d.CoordinateTransformer(ToolShape.GLOBAL.listArea.polygonArea.getPaths()[0]),i=r.center,t=null;t=new map4d.Marker({position:{lat:i.lat,lng:i.lng},anchor:[.5,.5],visible:!0,label:new map4d.MarkerLabel({text:n+" m2",color:"000000",fontSize:11}),icon:new map4d.Icon(32,32,"")});t.setMap(map);ToolShape.GLOBAL.listArea.listMerterArea.push(t)},createMarkerDrawLoDat:function(n,t,i){let r=new map4d.Marker({position:{lat:n,lng:t},icon:new map4d.Icon(8,8,"/Content/Map/images/yellow-point.png"),anchor:[.5,.5]});r.setMap(map);i?ToolShape.GLOBAL.listArea.listMarkerArea.push(r):ToolShape.GLOBAL.listDistance.listMarkerDistance.push(r)},createPolylineLoDat:function(n,t,i,r){ToolShape.GLOBAL.polylineTemp!=null&&ToolShape.GLOBAL.polylineTemp.setMap(null);var u=new map4d.Polyline({path:n,visible:!0,strokeColor:"#FF8264",strokeWidth:t,strokeOpacity:i,closed:!1});u.setMap(map);r?ToolShape.GLOBAL.listDistance.listPolylineDistance.push(u):ToolShape.GLOBAL.listArea.PolylineArea=u},createPolygonArea:function(n){ToolShape.GLOBAL.listArea.polygonArea!=null&&ToolShape.GLOBAL.listArea.polygonArea.setMap(null);ToolShape.GLOBAL.polylineTemp!=null&&ToolShape.GLOBAL.polylineTemp.setMap(null);let t=map4d.PolygonOptions={paths:[n],fillOpacity:.5};ToolShape.GLOBAL.listArea.polygonArea=new map4d.Polygon(t);ToolShape.GLOBAL.listArea.polygonArea.setMap(map)},setShowHideDistance:function(n){n?($(ToolShape.SELECTORS.btnRuleDistance).addClass("btn-active"),ToolShape.GLOBAL.isStartDistance=!0):($(ToolShape.SELECTORS.btnRuleDistance).removeClass("btn-active"),ToolShape.GLOBAL.isStartDistance=!1)},setShowHideArea:function(n){n?($(ToolShape.SELECTORS.btnRuleArea).addClass("btn-active"),ToolShape.GLOBAL.isStartArea=!0):($(ToolShape.SELECTORS.btnRuleArea).removeClass("btn-active"),ToolShape.GLOBAL.isStartArea=!1)},splitStringDistance:function(n){var t=n.split(" ");return t.length>0?Number(t[0]):0},replayRuleShape:function(){let n=ToolShape.GLOBAL.listDistance;$.each(n.listMarkerDistance,function(t,i){i.setMap(null);typeof n.listMerterDistance[t]!=undefined&&n.listMerterDistance[t]!=null&&n.listMerterDistance[t].setMap(null);typeof n.listPolylineDistance[t]!=undefined&&n.listPolylineDistance[t]!=null&&n.listPolylineDistance[t].setMap(null)});n.listMarkerDistance=[];n.listMerterDistance=[];n.listPolylineDistance=[];isStartDistance=!1;ToolShape.setShowHideDistance(!1);let t=ToolShape.GLOBAL.listArea;$.each(t.listMerterArea,function(n,i){i.setMap(null);typeof t.listMarkerArea[n]!=undefined&&t.listMarkerArea[n]!=null&&t.listMarkerArea[n].setMap(null)});t.polygonArea!=null&&t.polygonArea.setMap(null);t.listMarkerArea=[];t.listMerterArea=[];t.polygonArea=null;isStartArea=!1;ToolShape.setShowHideArea(!1)},calculatorAraePolygon:function(n){let t=[],i;$.each(n,function(n,r){i=[r.lng,r.lat];t.push(i)});let r=new map4d.Measure(t);return r.area},checkFormTrichXuat:function(){let n=!0,t=$(ToolShape.SELECTORS.inputSoThua).val();validateText(t,"number",0,0)&&t!=="0"||(insertError($(ToolShape.SELECTORS.inputSoThua),"other"),n=!1);let i=$(ToolShape.SELECTORS.inputSoTo).val();return validateText(i,"number",0,0)&&i!=="0"||(insertError($(ToolShape.SELECTORS.inputSoTo),"other"),n=!1),n}};